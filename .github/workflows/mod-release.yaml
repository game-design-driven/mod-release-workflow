name: Mod Release & Downstream Sync
concurrency:
  group: mod-release-${{ github.event.repository.name }}
  cancel-in-progress: false

on:
  workflow_call:
    inputs:
      modrinth_slug:
        description: 'Modrinth slug for packwiz (defaults to repo name lowercase)'
        required: false
        type: string
        default: ''
      curseforge_slug:
        description: 'CurseForge slug for packwiz (defaults to repo name lowercase)'
        required: false
        type: string
        default: ''
      loader:
        description: 'Mod loader (forge, fabric, neoforge, quilt)'
        required: true
        type: string
      mc_version:
        description: 'Minecraft version'
        required: true
        type: string
      java_version:
        description: 'Java version for build'
        required: false
        type: string
        default: '17'
      target_modpack_repo:
        description: 'Downstream modpack repo to PR (org/repo format)'
        required: false
        type: string
        default: ''
      manual_bump:
        description: 'Version bump type override'
        required: false
        type: string
        default: 'patch'
      modrinth_id:
        description: 'Modrinth project ID'
        required: false
        type: string
        default: ''
      curseforge_id:
        description: 'CurseForge project ID'
        required: false
        type: string
        default: ''
      enable_modrinth_sync:
        description: 'Enable Modrinth modpack sync'
        required: false
        type: boolean
        default: false
      enable_curseforge_sync:
        description: 'Enable CurseForge modpack sync'
        required: false
        type: boolean
        default: false
      curseforge_modpack_path:
        description: 'Path to curseforge pack.toml in modpack repo'
        required: false
        type: string
        default: './curseforge'
      enable_github_release:
        description: 'Enable GitHub release creation'
        required: false
        type: boolean
        default: true
    secrets:
      GH_TOKEN:
        description: 'GitHub token with repo access'
        required: true
      MODRINTH_TOKEN:
        description: 'Modrinth API token'
        required: false
      CURSEFORGE_TOKEN:
        description: 'CurseForge API token'
        required: false

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate JSON and YAML files
        uses: GrantBirki/json-yaml-validate@v2.4.0

  tag_and_release:
    needs: [tests]
    permissions:
      contents: write
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.tag_version.outputs.new_tag }}
      changelog: ${{ steps.tag_version.outputs.changelog }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bump version and push tag
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.1
        with:
          tag_prefix: ""
          default_bump: ${{ inputs.manual_bump }}
          custom_release_rules: |
            feat:minor:Features,
            overhaul:minor:Overhaul,
            fix:patch:Bug fixes,
            refactor:patch:Refactor,
            chore:patch:Maintenance,
            docs:patch:Documentation,
            test:patch:Testing,
            ci:patch:Continuous Integration,
            revert:patch:Reverted Changes
          github_token: ${{ secrets.GH_TOKEN }}

  build:
    needs: [tag_and_release]
    permissions:
      contents: write
    runs-on: ubuntu-latest
    outputs:
      jar_name: ${{ steps.share_info.outputs.jar_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Update version files
        run: |
          if [ -f "./update_version.sh" ]; then
            chmod +x ./update_version.sh
            ./update_version.sh ${{ needs.tag_and_release.outputs.new_tag }}
          else
            echo "No update_version.sh found, skipping version file update"
          fi

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ inputs.java_version }}
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Build with Gradle
        run: |
          chmod +x gradlew
          ./gradlew build

      - name: Capture Jar Name
        id: share_info
        run: |
          shopt -s extglob
          JAR=$(ls build/libs/!(*-all|*-sources|*-javadoc).jar | xargs basename)
          echo "jar_name=$JAR" >> $GITHUB_OUTPUT

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: built-jar
          path: build/libs/*.jar

      - name: Commit version bump back to repo
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(version): update to ${{ needs.tag_and_release.outputs.new_tag }} [skip ci]"
          branch: ${{ github.ref_name }}

  github_release:
    name: "publish (GitHub)"
    needs: [tag_and_release, build]
    if: inputs.enable_github_release
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download built jar
        uses: actions/download-artifact@v4
        with:
          name: built-jar
          path: build/libs

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.tag_and_release.outputs.new_tag }}
          name: "${{ github.event.repository.name }}-${{ needs.tag_and_release.outputs.new_tag }}+${{ inputs.loader }}-${{ inputs.mc_version }}"
          body: ${{ needs.tag_and_release.outputs.changelog }}
          files: build/libs/*.jar
          token: ${{ secrets.GH_TOKEN }}

  publish:
    name: "publish (${{ inputs.modrinth_id != '' && 'Modrinth' || '' }}${{ inputs.modrinth_id != '' && inputs.curseforge_id != '' && ', ' || '' }}${{ inputs.curseforge_id != '' && 'CurseForge' || '' }})"
    needs: [tag_and_release, build]
    if: inputs.modrinth_id != '' || inputs.curseforge_id != ''
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download built jar
        uses: actions/download-artifact@v4
        with:
          name: built-jar
          path: build/libs

      - name: Read dependencies
        id: deps
        run: |
          if [ -f "dependencies.txt" ]; then
            DEPS=$(cat dependencies.txt | tr '\n' '|' | sed 's/|$//')
            echo "value=$DEPS" >> $GITHUB_OUTPUT
          else
            echo "value=" >> $GITHUB_OUTPUT
          fi

      - name: Publish to Platforms
        uses: Kir-Antipov/mc-publish@v3.3.0
        with:
          modrinth-id: ${{ inputs.modrinth_id }}
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
          curseforge-id: ${{ inputs.curseforge_id }}
          curseforge-token: ${{ secrets.CURSEFORGE_TOKEN }}
          loaders: ${{ inputs.loader }}
          game-versions: ${{ inputs.mc_version }}
          files: "build/libs/!(*-all|*-sources|*-javadoc).jar"
          name: "${{ github.event.repository.name }}-${{ needs.tag_and_release.outputs.new_tag }}+${{ inputs.loader }}-${{ inputs.mc_version }}"
          version: ${{ needs.tag_and_release.outputs.new_tag }}
          version-type: release
          changelog: ${{ needs.tag_and_release.outputs.changelog }}
          java: ${{ inputs.java_version }}
          dependencies: ${{ steps.deps.outputs.value }}

  update_descriptions:
    needs: [publish]
    if: inputs.modrinth_id != '' || inputs.curseforge_id != ''
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Read README
        id: readme
        run: |
          if [ -f "README.md" ]; then
            # Store content for API calls
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Update Modrinth Description
        if: inputs.modrinth_id != '' && steps.readme.outputs.found == 'true'
        env:
          MODRINTH_TOKEN: ${{ secrets.MODRINTH_TOKEN }}
        run: |
          if [ -z "$MODRINTH_TOKEN" ]; then
            echo "No MODRINTH_TOKEN provided, skipping"
            exit 0
          fi
          curl -sf -X PATCH "https://api.modrinth.com/v2/project/${{ inputs.modrinth_id }}" \
            -H "Authorization: $MODRINTH_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg body "$(cat README.md)" '{body: $body}')" \
            && echo "Modrinth description updated" \
            || echo "Modrinth description update failed (non-fatal)"

  make_pr_for_modpack:
    needs: [publish, tag_and_release]
    if: inputs.target_modpack_repo != '' && (inputs.enable_modrinth_sync || inputs.enable_curseforge_sync)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Modpack
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.target_modpack_repo }}
          token: ${{ secrets.GH_TOKEN }}
          ref: main

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.19'

      - name: Install packwiz
        run: |
          go install github.com/packwiz/packwiz@latest
          sudo cp $(go env GOPATH)/bin/packwiz /usr/local/bin/

      - name: Setup uv
        uses: astral-sh/setup-uv@v4

      - name: Fetch sync script
        run: |
          curl -sSL "https://raw.githubusercontent.com/game-design-driven/mod-release-workflow/main/scripts/sync_mod.py" -o sync_mod.py
          chmod +x sync_mod.py

      - name: Compute slugs
        id: slugs
        run: |
          DEFAULT=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')
          MR_SLUG="${{ inputs.modrinth_slug }}"
          CF_SLUG="${{ inputs.curseforge_slug }}"
          echo "modrinth=${MR_SLUG:-$DEFAULT}" >> $GITHUB_OUTPUT
          echo "curseforge=${CF_SLUG:-$DEFAULT}" >> $GITHUB_OUTPUT

      - name: Sync Modrinth Modpack
        id: sync_mr
        if: inputs.enable_modrinth_sync
        run: |
          uv run sync_mod.py "." "${{ steps.slugs.outputs.modrinth }}" "mr" \
            "${{ needs.tag_and_release.outputs.new_tag }}" "${{ inputs.mc_version }}" "${{ inputs.loader }}"

      - name: Sync Curseforge Modpack
        id: sync_cf
        if: inputs.enable_curseforge_sync
        run: |
          uv run sync_mod.py "${{ inputs.curseforge_modpack_path }}" "${{ steps.slugs.outputs.curseforge }}" "cf" \
            "${{ needs.tag_and_release.outputs.new_tag }}" "${{ inputs.mc_version }}" "${{ inputs.loader }}"

      - name: Get sync action
        id: check_mod
        run: |
          # Use action from whichever sync ran
          if [ -n "${{ steps.sync_mr.outputs.action }}" ]; then
            echo "action=${{ steps.sync_mr.outputs.action }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ steps.sync_cf.outputs.action }}" ]; then
            echo "action=${{ steps.sync_cf.outputs.action }}" >> $GITHUB_OUTPUT
          else
            echo "action=update" >> $GITHUB_OUTPUT
          fi

      - name: Cleanup
        run: rm -f sync_mod.py

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GH_TOKEN }}
          commit-message: "mods: ${{ steps.check_mod.outputs.action }} ${{ github.event.repository.name }} to ${{ needs.tag_and_release.outputs.new_tag }}"
          title: "${{ steps.check_mod.outputs.action == 'add' && 'Add' || 'Update' }} ${{ github.event.repository.name }} to ${{ needs.tag_and_release.outputs.new_tag }}"
          branch: "${{ steps.check_mod.outputs.action }}/${{ steps.slugs.outputs.modrinth }}"
          body: |
            ## Mod ${{ steps.check_mod.outputs.action == 'add' && 'Addition' || 'Update' }}: ${{ github.event.repository.name }}
            - **Version**: `${{ needs.tag_and_release.outputs.new_tag }}`
            - **Target MC**: `${{ inputs.mc_version }}`-`${{ inputs.loader }}`
            - **Syncs**: Modrinth (${{ inputs.enable_modrinth_sync }}), CurseForge (${{ inputs.enable_curseforge_sync }})

            ## Changelog
            ${{ needs.tag_and_release.outputs.changelog }}

            ---
            *This PR was automatically generated by the mod-release workflow.*
