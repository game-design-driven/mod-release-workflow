name: Mod Release & Downstream Sync
concurrency:
  group: mod-release-${{ github.event.repository.name }}
  cancel-in-progress: false

on:
  workflow_call:
    inputs:
      java_version:
        description: 'Java version for build'
        required: false
        type: string
        default: '17'
      target_modpack_repo:
        description: 'Downstream modpack repo to PR (org/repo format)'
        required: false
        type: string
        default: ''
      manual_bump:
        description: 'Version bump type override'
        required: false
        type: string
        default: 'patch'
      enable_modrinth_sync:
        description: 'Enable Modrinth modpack sync'
        required: false
        type: boolean
        default: false
      enable_curseforge_sync:
        description: 'Enable CurseForge modpack sync'
        required: false
        type: boolean
        default: false
      curseforge_modpack_path:
        description: 'Path to curseforge pack.toml in modpack repo'
        required: false
        type: string
        default: './curseforge'
      enable_github_release:
        description: 'Enable GitHub release creation'
        required: false
        type: boolean
        default: true
    secrets:
      GH_TOKEN:
        description: 'GitHub token with repo access'
        required: true
      MODRINTH_TOKEN:
        description: 'Modrinth API token'
        required: true
      CURSEFORGE_TOKEN:
        description: 'CurseForge API token'
        required: true

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup uv
        uses: astral-sh/setup-uv@v4
      - name: Validate JSON and YAML files
        uses: GrantBirki/json-yaml-validate@v3
        with:
          exclude: |
            build/**
            .gradle/**
            .idea/**
            run/**
            runs/**
      - name: Checkout workflow repo
        uses: actions/checkout@v4
        with:
          repository: game-design-driven/mod-release-workflow
          ref: main
          path: workflow
      - name: Validate mods.toml metadata
        run: uv run workflow/scripts/mods_toml.py

  tag_and_release:
    needs: [tests]
    permissions:
      contents: write
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.tag_version.outputs.new_tag }}
      changelog: ${{ steps.tag_version.outputs.changelog }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bump version and push tag
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.1
        with:
          tag_prefix: ""
          default_bump: ${{ inputs.manual_bump }}
          custom_release_rules: |
            feat:minor:Features,
            overhaul:minor:Overhaul,
            fix:patch:Bug fixes,
            refactor:patch:Refactor,
            chore:patch:Maintenance,
            docs:patch:Documentation,
            test:patch:Testing,
            ci:patch:Continuous Integration,
            revert:patch:Reverted Changes
          github_token: ${{ secrets.GH_TOKEN }}

  build:
    needs: [tag_and_release]
    permissions:
      contents: write
    runs-on: ubuntu-latest
    outputs:
      jar_name: ${{ steps.share_info.outputs.jar_name }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ inputs.java_version }}
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Build with Gradle
        run: |
          chmod +x gradlew
          ./gradlew build

      - name: Capture Jar Name
        id: share_info
        run: |
          shopt -s extglob
          JAR=$(ls build/libs/!(*-all|*-sources|*-javadoc).jar | xargs basename)
          echo "jar_name=$JAR" >> $GITHUB_OUTPUT

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: built-jar
          path: build/libs/*.jar

  github_release:
    name: "publish (GitHub)"
    needs: [tag_and_release, build]
    if: inputs.enable_github_release
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Checkout workflow repo
        uses: actions/checkout@v4
        with:
          repository: game-design-driven/mod-release-workflow
          ref: main
          path: workflow
      - name: Setup uv
        uses: astral-sh/setup-uv@v4
      - name: Read mods.toml
        id: meta
        run: uv run workflow/scripts/mods_toml.py --write-outputs

      - name: Download built jar
        uses: actions/download-artifact@v4
        with:
          name: built-jar
          path: build/libs

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.tag_and_release.outputs.new_tag }}
          name: "${{ github.event.repository.name }}-${{ needs.tag_and_release.outputs.new_tag }}+${{ steps.meta.outputs.loader }}-${{ steps.meta.outputs.mc_version }}"
          body: ${{ needs.tag_and_release.outputs.changelog }}
          files: build/libs/*.jar
          token: ${{ secrets.GH_TOKEN }}

  publish:
    name: "publish"
    needs: [tag_and_release, build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Checkout workflow repo
        uses: actions/checkout@v4
        with:
          repository: game-design-driven/mod-release-workflow
          ref: main
          path: workflow
      - name: Setup uv
        uses: astral-sh/setup-uv@v4
      - name: Read mods.toml
        id: meta
        run: uv run workflow/scripts/mods_toml.py --write-outputs

      - name: Download built jar
        uses: actions/download-artifact@v4
        with:
          name: built-jar
          path: build/libs

      - name: Publish to Platforms
        uses: Kir-Antipov/mc-publish@v3.3.0
        with:
          modrinth-id: ${{ steps.meta.outputs.modrinth_id }}
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
          curseforge-id: ${{ steps.meta.outputs.curseforge_id }}
          curseforge-token: ${{ secrets.CURSEFORGE_TOKEN }}
          loaders: ${{ steps.meta.outputs.loader }}
          game-versions: ${{ steps.meta.outputs.mc_version }}
          files: "build/libs/!(*-all|*-sources|*-javadoc).jar"
          name: "${{ github.event.repository.name }}-${{ needs.tag_and_release.outputs.new_tag }}+${{ steps.meta.outputs.loader }}-${{ steps.meta.outputs.mc_version }}"
          version: ${{ needs.tag_and_release.outputs.new_tag }}
          version-type: release
          changelog: ${{ needs.tag_and_release.outputs.changelog }}
          java: ${{ inputs.java_version }}

  update_descriptions:
    needs: [publish]
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - name: Checkout workflow repo
        uses: actions/checkout@v4
        with:
          repository: game-design-driven/mod-release-workflow
          ref: main
          path: workflow
      - name: Setup uv
        uses: astral-sh/setup-uv@v4
      - name: Read mods.toml
        id: meta
        run: uv run workflow/scripts/mods_toml.py --write-outputs

      - name: Read README
        id: readme
        run: |
          if [ -f "README.md" ]; then
            # Store content for API calls
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Update Modrinth Description
        if: steps.readme.outputs.found == 'true'
        env:
          MODRINTH_TOKEN: ${{ secrets.MODRINTH_TOKEN }}
        run: |
          if [ -z "$MODRINTH_TOKEN" ]; then
            echo "No MODRINTH_TOKEN provided, skipping"
            exit 0
          fi
          curl -sf -X PATCH "https://api.modrinth.com/v2/project/${{ steps.meta.outputs.modrinth_id }}" \
            -H "Authorization: $MODRINTH_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg body "$(cat README.md)" '{body: $body}')" \
            && echo "Modrinth description updated" \
            || echo "Modrinth description update failed (non-fatal)"

  make_pr_for_modpack:
    needs: [publish, tag_and_release]
    if: inputs.target_modpack_repo != '' && (inputs.enable_modrinth_sync || inputs.enable_curseforge_sync)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Mod Repo
        uses: actions/checkout@v4
        with:
          path: mod-repo

      - name: Checkout workflow repo
        uses: actions/checkout@v4
        with:
          repository: game-design-driven/mod-release-workflow
          ref: main
          path: workflow

      - name: Setup uv
        uses: astral-sh/setup-uv@v4

      - name: Read mods.toml
        id: meta
        working-directory: mod-repo
        run: uv run ../workflow/scripts/mods_toml.py --write-outputs

      - name: Checkout Modpack
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.target_modpack_repo }}
          token: ${{ secrets.GH_TOKEN }}
          ref: main
          path: modpack

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.19'

      - name: Install packwiz
        run: |
          go install github.com/packwiz/packwiz@latest
          sudo cp $(go env GOPATH)/bin/packwiz /usr/local/bin/

      - name: Fetch sync script
        run: |
          curl -sSL "https://raw.githubusercontent.com/game-design-driven/mod-release-workflow/main/scripts/sync_mod.py" -o modpack/sync_mod.py
          chmod +x modpack/sync_mod.py

      - name: Sync Modrinth Modpack
        id: sync_mr
        if: inputs.enable_modrinth_sync
        run: |
          uv run modpack/sync_mod.py "modpack" "${{ steps.meta.outputs.modrinth_slug }}" "mr" \
            "${{ needs.tag_and_release.outputs.new_tag }}" "${{ steps.meta.outputs.mc_version }}" "${{ steps.meta.outputs.loader }}"

      - name: Sync Curseforge Modpack
        id: sync_cf
        if: inputs.enable_curseforge_sync
        run: |
          uv run modpack/sync_mod.py "modpack/${{ inputs.curseforge_modpack_path }}" "${{ steps.meta.outputs.curseforge_slug }}" "cf" \
            "${{ needs.tag_and_release.outputs.new_tag }}" "${{ steps.meta.outputs.mc_version }}" "${{ steps.meta.outputs.loader }}"

      - name: Get sync action
        id: check_mod
        run: |
          # Use action from whichever sync ran
          if [ -n "${{ steps.sync_mr.outputs.action }}" ]; then
            echo "action=${{ steps.sync_mr.outputs.action }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ steps.sync_cf.outputs.action }}" ]; then
            echo "action=${{ steps.sync_cf.outputs.action }}" >> $GITHUB_OUTPUT
          else
            echo "action=update" >> $GITHUB_OUTPUT
          fi

      - name: Cleanup
        run: rm -f modpack/sync_mod.py

      - name: Write pending mod changelog
        env:
          MOD_NAME: ${{ github.event.repository.name }}
          MOD_SLUG: ${{ steps.meta.outputs.modrinth_slug }}
          MOD_VERSION: ${{ needs.tag_and_release.outputs.new_tag }}
          MOD_CHANGELOG: ${{ needs.tag_and_release.outputs.changelog }}
        run: |
          if [ ! -d "modpack/modpack-update-checker" ]; then
            exit 0
          fi
          mkdir -p modpack/modpack-update-checker/pending
          {
            printf '## %s %s\n\n' "$MOD_NAME" "$MOD_VERSION"
            printf '%s\n' "$MOD_CHANGELOG"
          } > "modpack/modpack-update-checker/pending/${MOD_SLUG}-${MOD_VERSION}.md"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GH_TOKEN }}
          path: modpack
          commit-message: "mods: ${{ steps.check_mod.outputs.action }} ${{ github.event.repository.name }} to ${{ needs.tag_and_release.outputs.new_tag }}"
          title: "${{ steps.check_mod.outputs.action == 'add' && 'Add' || 'Update' }} ${{ github.event.repository.name }} to ${{ needs.tag_and_release.outputs.new_tag }}"
          branch: "${{ steps.check_mod.outputs.action }}/${{ steps.meta.outputs.modrinth_slug }}"
          body: |
            ## Mod ${{ steps.check_mod.outputs.action == 'add' && 'Addition' || 'Update' }}: ${{ github.event.repository.name }}
            - **Version**: `${{ needs.tag_and_release.outputs.new_tag }}`
            - **Target MC**: `${{ steps.meta.outputs.mc_version }}`-`${{ steps.meta.outputs.loader }}`
            - **Syncs**: Modrinth (${{ inputs.enable_modrinth_sync }}), CurseForge (${{ inputs.enable_curseforge_sync }})

            ## Changelog
            ${{ needs.tag_and_release.outputs.changelog }}

            ---
            *This PR was automatically generated by the mod-release workflow.*
